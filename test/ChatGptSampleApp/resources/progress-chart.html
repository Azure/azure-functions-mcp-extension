<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progress Charts</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }

        .charts-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 24px;
        }

            .header h1 {
                font-size: 24px;
                background: linear-gradient(90deg, #00d9ff, #00ff88);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }

        .time-filter {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .filter-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #888;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

            .filter-btn.active {
                background: rgba(0, 217, 255, 0.2);
                border-color: #00d9ff;
                color: #00d9ff;
            }

        .chart-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-wrapper {
            position: relative;
            height: 250px;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .mini-stat {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .mini-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #00d9ff;
        }

        .mini-stat-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            margin-top: 4px;
        }

        .mini-stat-change {
            font-size: 11px;
            margin-top: 4px;
        }

            .mini-stat-change.positive {
                color: #00ff88;
            }

            .mini-stat-change.negative {
                color: #ff6b6b;
            }

        .exercise-selector {
            margin-bottom: 16px;
        }

            .exercise-selector select {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 8px;
                padding: 10px 16px;
                color: #fff;
                font-size: 14px;
                cursor: pointer;
                min-width: 200px;
            }

        .pr-timeline {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .pr-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px;
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 8px;
        }

        .pr-icon {
            font-size: 24px;
        }

        .pr-details {
            flex: 1;
        }

        .pr-exercise {
            font-weight: 600;
            color: #ffd700;
        }

        .pr-stats {
            font-size: 13px;
            color: #888;
            margin-top: 4px;
        }

        .pr-date {
            font-size: 12px;
            color: #666;
        }

        .pr-item.recent {
            background: rgba(255, 107, 53, 0.1);
            border-color: rgba(255, 107, 53, 0.3);
        }

        .pr-muscle {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="charts-container">
        <div class="header">
            <h1>üìà Progress Tracker</h1>
            <div class="time-filter">
                <button class="filter-btn" data-days="7">7 Days</button>
                <button class="filter-btn active" data-days="30">30 Days</button>
                <button class="filter-btn" data-days="90">90 Days</button>
                <button class="filter-btn" data-days="365">1 Year</button>
            </div>
        </div>

        <div class="stats-row">
            <div class="mini-stat">
                <div class="mini-stat-value" id="total-workouts">-</div>
                <div class="mini-stat-label">Workouts</div>
                <div class="mini-stat-change" id="workouts-change"></div>
            </div>
            <div class="mini-stat">
                <div class="mini-stat-value" id="total-volume">-</div>
                <div class="mini-stat-label">Total Volume</div>
                <div class="mini-stat-change" id="volume-change"></div>
            </div>
            <div class="mini-stat">
                <div class="mini-stat-value" id="consistency">-</div>
                <div class="mini-stat-label">Consistency</div>
                <div class="mini-stat-change" id="consistency-change"></div>
            </div>
            <div class="mini-stat">
                <div class="mini-stat-value" id="avg-duration">-</div>
                <div class="mini-stat-label">Avg Minutes</div>
                <div class="mini-stat-change" id="duration-change"></div>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-title">üìä Weekly Volume Trend</div>
            <div class="chart-wrapper">
                <canvas id="volumeChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-title">üéØ Muscle Group Distribution</div>
            <div class="chart-wrapper">
                <canvas id="muscleChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-title">üí™ Strength Progression</div>
            <div class="exercise-selector">
                <select id="exercise-select">
                    <option value="">Select an exercise...</option>
                </select>
            </div>
            <div class="chart-wrapper">
                <canvas id="strengthChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-title">üèÜ Recent Personal Records</div>
            <div class="pr-timeline" id="pr-timeline">
                <div class="loading">Loading PRs...</div>
            </div>
        </div>
    </div>

    <script>
        // Global chart instances
        let volumeChart, muscleChart, strengthChart;

        // Chart.js configuration
        Chart.defaults.color = '#888';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';

        // Initialize the app
        function initApp() {
            console.log('Progress Charts initializing...');

            // Apply theme
            if (window.openai?.theme) {
                document.body.className = window.openai.theme;
            }

            // Listen for theme changes
            window.addEventListener('openai:set_globals', (event) => {
                if (event.detail?.globals?.theme) {
                    document.body.className = event.detail.globals.theme;
                }
            });

            // Get data from window.openai
            const toolInput = window.openai?.toolInput || null;
            const toolOutput = window.openai?.toolOutput || null;
            const metadata = window.openai?.toolResponseMetadata || null;

            console.log('toolInput:', toolInput);
            console.log('toolOutput:', toolOutput);
            console.log('metadata:', metadata);

            // Setup button event listeners
            setupFilterButtons();

            // Initialize charts
            initCharts();

            // Populate with data - try toolOutput first, then toolInput
            if (toolOutput) {
                console.log('Populating charts with toolOutput:', toolOutput);
                populateCharts(toolOutput);
            } else if (toolInput) {
                console.log('Populating charts with toolInput:', toolInput);
                populateCharts(toolInput);
            } else {
                console.log('No data available, showing empty state');
                showEmptyState();
            }
        }

        function initCharts() {
            // Only initialize if charts don't already exist
            if (volumeChart || muscleChart || strengthChart) {
                console.log('Charts already initialized, skipping...');
                return;
            }

            console.log('Initializing charts for the first time...');

            // Volume Chart
            const volumeCtx = document.getElementById('volumeChart').getContext('2d');
            volumeChart = new Chart(volumeCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Volume (lbs)',
                        data: [],
                        backgroundColor: 'rgba(0, 217, 255, 0.6)',
                        borderColor: '#00d9ff',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: {
                                callback: value => (value / 1000).toFixed(0) + 'K'
                            }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });

            // Muscle Distribution Chart
            const muscleCtx = document.getElementById('muscleChart').getContext('2d');
            muscleChart = new Chart(muscleCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#00d9ff',
                            '#00ff88',
                            '#ff6b35',
                            '#ffd700',
                            '#ff6b6b',
                            '#9b59b6',
                            '#3498db',
                            '#e74c3c'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 16,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });

            // Strength Progression Chart
            const strengthCtx = document.getElementById('strengthChart').getContext('2d');
            strengthChart = new Chart(strengthCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Max Weight (lbs)',
                        data: [],
                        borderColor: '#00ff88',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: '#00ff88',
                        pointBorderColor: '#fff',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function setupFilterButtons() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    const days = parseInt(btn.dataset.days);

                    // Request updated data via follow-up message
                    if (window.openai?.sendFollowUpMessage) {
                        await window.openai.sendFollowUpMessage({
                            prompt: `Show my workout stats for the last ${days} days`
                        });
                    }
                });
            });

                // Exercise selector - update chart from local data
                document.getElementById('exercise-select').addEventListener('change', (e) => {
                    const exercise = e.target.value;
                    if (!exercise) return;
                    updateStrengthChart(exercise);
                });
            }

        function populateCharts(data) {
            console.log('========================================');
            console.log('=== populateCharts START ===');
            console.log('========================================');
            console.log('Raw data received:', data);
            console.log('Data type:', typeof data);
            console.log('Data keys:', data ? Object.keys(data) : 'null');

            // If data is wrapped in .text property, parse it
            if (data && data.text && typeof data.text === 'string') {
                console.log('‚ö†Ô∏è Data has .text property, parsing JSON...');
                console.log('Raw .text value:', data.text);
                try {
                    data = JSON.parse(data.text);
                    console.log('‚úÖ Successfully parsed data from .text');
                    console.log('Parsed data:', data);
                    console.log('Parsed data keys:', Object.keys(data));
                } catch (e) {
                    console.error('‚ùå Failed to parse data.text:', e);
                }
            }

            if (!data) {
                console.log('‚ùå No data after parsing - showing empty state');
                showEmptyState();
                return;
            }

            console.log('--- Extracting properties ---');

            // Helper to get property with both naming conventions
            const getProp = (obj, pascalName, camelName) => {
                const pascalValue = obj[pascalName];
                const camelValue = obj[camelName];
                console.log(`getProp(${pascalName}/${camelName}): PascalCase=${pascalValue}, camelCase=${camelValue}`);
                return pascalValue !== undefined ? pascalValue : camelValue;
            };

            // Populate summary stats
            console.log('--- Setting Summary Stats ---');

            const totalWorkouts = getProp(data, 'TotalWorkouts', 'totalWorkouts');
            if (totalWorkouts !== undefined) {
                console.log('‚úÖ Setting total workouts:', totalWorkouts);
                document.getElementById('total-workouts').textContent = totalWorkouts;
            } else {
                console.log('‚ö†Ô∏è totalWorkouts is undefined');
            }

            const totalVolume = getProp(data, 'TotalVolumeLifted', 'totalVolumeLifted');
            if (totalVolume !== undefined) {
                console.log('‚úÖ Setting total volume:', totalVolume);
                document.getElementById('total-volume').textContent = formatVolume(totalVolume);
            } else {
                console.log('‚ö†Ô∏è totalVolumeLifted is undefined');
            }

            const consistency = getProp(data, 'ConsistencyScore', 'consistencyScore');
            if (consistency !== undefined) {
                console.log('‚úÖ Setting consistency:', consistency);
                document.getElementById('consistency').textContent = Math.round(consistency) + '%';
            } else {
                console.log('‚ö†Ô∏è consistencyScore is undefined');
            }

            const workoutsPerWeek = getProp(data, 'WorkoutsPerWeek', 'workoutsPerWeek');
            if (workoutsPerWeek !== undefined) {
                console.log('‚úÖ Setting workouts per week:', workoutsPerWeek);
                document.getElementById('avg-duration').textContent = workoutsPerWeek.toFixed(1);
            } else {
                console.log('‚ö†Ô∏è workoutsPerWeek is undefined');
            }

            console.log('--- Processing Charts Data ---');

            // Populate weekly trend chart
            const weeklyTrend = getProp(data, 'WeeklyTrend', 'weeklyTrend');
            console.log('weeklyTrend extracted:', weeklyTrend);
            console.log('weeklyTrend is array:', Array.isArray(weeklyTrend));
            if (weeklyTrend && Array.isArray(weeklyTrend)) {
                console.log('‚úÖ Calling updateVolumeChart with:', weeklyTrend);
                updateVolumeChart(weeklyTrend);
            } else {
                console.log('‚ùå weeklyTrend not found or not an array');
            }

            // Populate muscle distribution chart
            const muscleDistribution = getProp(data, 'MuscleGroupDistribution', 'muscleGroupDistribution');
            console.log('muscleDistribution extracted:', muscleDistribution);
            console.log('muscleDistribution type:', typeof muscleDistribution);
            if (muscleDistribution && typeof muscleDistribution === 'object') {
                console.log('‚úÖ Calling updateMuscleChart with:', muscleDistribution);
                updateMuscleChart(muscleDistribution);
            } else {
                console.log('‚ùå muscleDistribution not found or not an object');
            }

            // Populate exercise selector with exercise names
            const exerciseNames = getProp(data, 'ExerciseNames', 'exerciseNames');
            if (exerciseNames && Array.isArray(exerciseNames)) {
                console.log('‚úÖ Populating exercise selector with:', exerciseNames);
                populateExerciseSelector(exerciseNames);
            } else {
                console.log('‚ö†Ô∏è exerciseNames not found');
            }

            // Store exercise progressions globally for chart updates
            const exerciseProgressions = getProp(data, 'ExerciseProgressions', 'exerciseProgressions');
            if (exerciseProgressions && Array.isArray(exerciseProgressions)) {
                console.log('‚úÖ Storing exercise progressions:', exerciseProgressions.length, 'exercises');
                window.exerciseProgressions = exerciseProgressions;

                // Auto-select first exercise if available
                if (exerciseProgressions.length > 0) {
                    const firstExercise = exerciseProgressions[0];
                    const exerciseName = firstExercise.ExerciseName || firstExercise.exerciseName;
                    updateStrengthChart(exerciseName);
                    document.getElementById('exercise-select').value = exerciseName;
                }
            } else {
                console.log('‚ö†Ô∏è exerciseProgressions not found');
                window.exerciseProgressions = [];
            }

            // Populate personal records
            const personalRecords = getProp(data, 'PersonalRecords', 'personalRecords');
            if (personalRecords && Array.isArray(personalRecords)) {
                console.log('‚úÖ Populating PRs:', personalRecords.length, 'records');
                populatePRs(personalRecords);
            } else {
                console.log('‚ö†Ô∏è personalRecords not found - showing empty state');
                showEmptyState();
            }

            // Show recent fatigue if available
            const recentFatigue = getProp(data, 'RecentFatigue', 'recentFatigue');
            if (recentFatigue) {
                console.log('‚úÖ Recent fatigue:', recentFatigue);
            } else {
                console.log('‚ö†Ô∏è recentFatigue not found');
            }

            console.log('========================================');
            console.log('=== populateCharts END ===');
            console.log('========================================');
        }

        function updateVolumeChart(weeklyTrend) {
            console.log('=== updateVolumeChart START ===');
            console.log('weeklyTrend received:', weeklyTrend);
            console.log('weeklyTrend type:', typeof weeklyTrend);
            console.log('weeklyTrend is array:', Array.isArray(weeklyTrend));
            console.log('weeklyTrend length:', weeklyTrend?.length);

            if (!weeklyTrend || weeklyTrend.length === 0) {
                console.log('‚ùå No weekly trend data - aborting');
                return;
            }

            const labels = weeklyTrend.map((w, index) => {
                const week = w.Week || w.week || index + 1;
                console.log(`Processing week ${index}:`, w, '-> label:', `Week ${week}`);
                return `Week ${week}`;
            });

            const data = weeklyTrend.map((w, index) => {
                const volume = w.TotalVolume || w.totalVolume || 0;
                console.log(`Processing volume ${index}:`, w, '-> volume:', volume);
                return volume;
            });

            console.log('‚úÖ Volume chart labels:', labels);
            console.log('‚úÖ Volume chart data:', data);
            console.log('Updating chart object:', volumeChart);

            volumeChart.data.labels = labels;
            volumeChart.data.datasets[0].data = data;
            volumeChart.update();

            console.log('‚úÖ Volume chart updated successfully');
            console.log('=== updateVolumeChart END ===');
        }

        function updateMuscleChart(distribution) {
            console.log('=== updateMuscleChart START ===');
            console.log('distribution received:', distribution);
            console.log('distribution type:', typeof distribution);
            console.log('distribution keys:', distribution ? Object.keys(distribution) : 'null');

            if (!distribution || Object.keys(distribution).length === 0) {
                console.log('‚ùå No muscle distribution data - aborting');
                return;
            }

            const labels = Object.keys(distribution);
            const data = Object.values(distribution);

            console.log('‚úÖ Muscle chart labels:', labels);
            console.log('‚úÖ Muscle chart data:', data);
            console.log('Updating chart object:', muscleChart);

            muscleChart.data.labels = labels;
            muscleChart.data.datasets[0].data = data;
            muscleChart.update();

            console.log('‚úÖ Muscle chart updated successfully');
            console.log('=== updateMuscleChart END ===');
        }

        function populateExerciseSelector(exercises) {
            const select = document.getElementById('exercise-select');
            select.innerHTML = '<option value="">Select an exercise...</option>';

            if (Array.isArray(exercises)) {
                exercises.forEach(exercise => {
                    const option = document.createElement('option');
                    option.value = exercise;
                    option.textContent = exercise;
                    select.appendChild(option);
                });
            } else if (typeof exercises === 'object') {
                Object.keys(exercises).forEach(exercise => {
                    const option = document.createElement('option');
                    option.value = exercise;
                    option.textContent = exercise;
                    select.appendChild(option);
                });
            }
        }

        function updateStrengthChart(exerciseName) {
            console.log('=== updateStrengthChart START ===');
            console.log('Exercise selected:', exerciseName);

            if (!exerciseName || !window.exerciseProgressions) {
                console.log('‚ùå No exercise selected or no progression data');
                return;
            }

            // Find the progression data for this exercise
            const progression = window.exerciseProgressions.find(p => 
                (p.ExerciseName || p.exerciseName) === exerciseName
            );

            if (!progression) {
                console.log('‚ùå No progression data found for:', exerciseName);
                strengthChart.data.labels = [];
                strengthChart.data.datasets[0].data = [];
                strengthChart.update();
                return;
            }

            const dataPoints = progression.DataPoints || progression.dataPoints || [];
            console.log('Data points found:', dataPoints.length);

            if (dataPoints.length === 0) {
                console.log('‚ùå No data points for exercise');
                return;
            }

            const labels = dataPoints.map(dp => {
                const date = new Date(dp.Date || dp.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            const weights = dataPoints.map(dp => dp.MaxWeight || dp.maxWeight || 0);

            console.log('‚úÖ Strength chart labels:', labels);
            console.log('‚úÖ Strength chart data:', weights);

            strengthChart.data.labels = labels;
            strengthChart.data.datasets[0].data = weights;
            strengthChart.data.datasets[0].label = `${exerciseName} (lbs)`;
            strengthChart.update();

            console.log('‚úÖ Strength chart updated successfully');
            console.log('=== updateStrengthChart END ===');
        }

        function populatePRs(prs) {
            const container = document.getElementById('pr-timeline');

            if (!prs || prs.length === 0) {
                container.innerHTML = '<div class="empty-state">No personal records yet. Keep training!</div>';
                return;
            }

            const icons = ['ü•á', 'ü•à', 'ü•â', 'üèÜ', '‚≠ê'];

            container.innerHTML = prs.slice(0, 5).map((pr, index) => {
                const date = new Date(pr.DateAchieved || pr.dateAchieved || pr.Date || pr.date);
                const dateStr = formatWorkoutDate(date);
                const maxWeight = pr.MaxWeight || pr.maxWeight || 0;
                const reps = pr.Reps || pr.reps || 0;
                const e1rm = pr.EstimatedOneRepMax || pr.estimatedOneRepMax || calculateEstimated1RM(maxWeight, reps);
                const muscleGroup = pr.MuscleGroup || pr.muscleGroup || '';
                const isRecent = pr.IsRecent || pr.isRecent || false;

                return `
                        <div class="pr-item${isRecent ? ' recent' : ''}">
                            <span class="pr-icon">${icons[index] || 'üèÖ'}</span>
                            <div class="pr-details">
                                <div class="pr-exercise">${pr.ExerciseName || pr.exerciseName}${isRecent ? ' üî•' : ''}</div>
                                <div class="pr-stats">${maxWeight} lbs √ó ${reps} reps ‚Ä¢ Est. 1RM: ${Math.round(e1rm)} lbs</div>
                                ${muscleGroup ? `<div class="pr-muscle">${muscleGroup}</div>` : ''}
                            </div>
                            <div class="pr-date">${dateStr}</div>
                        </div>
                    `;
            }).join('');
        }

        function calculateEstimated1RM(weight, reps) {
            // Epley formula: 1RM = weight √ó (1 + reps / 30)
            return Math.round(weight * (1 + reps / 30));
        }

        function formatVolume(volume) {
            if (volume >= 1000) {
                return (volume / 1000).toFixed(1) + 'K';
            }
            return Math.round(volume).toString();
        }

        function formatWorkoutDate(date) {
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} week${Math.floor(diffDays / 7) > 1 ? 's' : ''} ago`;

            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function showEmptyState() {
            document.getElementById('pr-timeline').innerHTML = '<div class="empty-state">No personal records yet. Keep training!</div>';
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        // Re-render on global changes - but don't re-init charts
        window.addEventListener('openai:set_globals', (event) => {
            console.log('Globals updated, re-populating data...');

            // Just update the data, don't re-initialize everything
            const toolOutput = window.openai?.toolOutput || null;
            if (toolOutput) {
                console.log('Re-populating with new toolOutput:', toolOutput);
                populateCharts(toolOutput);
            }
        });
    </script>
</body>
</html>
