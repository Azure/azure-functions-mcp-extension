<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Dashboard</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

            .header h1 {
                font-size: 24px;
                background: linear-gradient(90deg, #00d9ff, #00ff88);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }

        .streak-badge {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #00d9ff;
        }

        .stat-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 4px;
        }

        .recent-workouts {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .workout-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.2s;
        }

            .workout-item:hover {
                background: rgba(0, 217, 255, 0.05);
                margin: 0 -8px;
                padding: 12px 8px;
                border-radius: 8px;
            }

            .workout-item:last-child {
                border-bottom: none;
            }

        .workout-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .workout-type {
            font-weight: 600;
            color: #fff;
        }

        .workout-date {
            font-size: 12px;
            color: #888;
        }

        .workout-duration {
            background: rgba(0, 217, 255, 0.1);
            color: #00d9ff;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
        }

        .quick-log {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
        }

        .quick-log-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .log-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

            .log-btn:hover {
                background: rgba(0, 217, 255, 0.2);
                border-color: #00d9ff;
            }

            .log-btn.primary {
                background: linear-gradient(135deg, #00d9ff, #00ff88);
                border: none;
                color: #1a1a2e;
                font-weight: 600;
                grid-column: span 3;
            }

        .muscle-chart {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .muscle-bar {
            flex: 1;
            min-width: 60px;
            text-align: center;
        }

        .muscle-bar-fill {
            height: 60px;
            background: linear-gradient(180deg, #00d9ff 0%, rgba(0, 217, 255, 0.3) 100%);
            border-radius: 4px 4px 0 0;
            margin-bottom: 4px;
            position: relative;
            transition: height 0.3s ease;
        }

        .muscle-bar-label {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
        }

        .pr-alert {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 107, 53, 0.2));
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .pr-alert-icon {
            font-size: 24px;
        }

        .pr-alert-text {
            font-size: 14px;
        }

        .pr-exercise {
            font-weight: 600;
            color: #ffd700;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #888;
        }

            .empty-state p {
                margin-bottom: 16px;
            }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>üí™ Workout Tracker</h1>
            <div class="streak-badge" id="streak-badge">üî• 0 Day Streak</div>
        </div>

        <div id="pr-alert-container"></div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="workouts-week">-</div>
                <div class="stat-label">This Week</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="workouts-month">-</div>
                <div class="stat-label">This Month</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-volume">-</div>
                <div class="stat-label">Volume (lbs)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avg-duration">-</div>
                <div class="stat-label">Avg. Minutes</div>
            </div>
        </div>

        <div class="recent-workouts">
            <div class="section-title">üìã Recent Workouts</div>
            <div id="recent-workouts-list">
                <div class="loading">Loading workouts...</div>
            </div>
        </div>

        <div class="recent-workouts">
            <div class="section-title">üìä Muscle Group Balance (Last 7 Days)</div>
            <div class="muscle-chart" id="muscle-chart">
                <div class="loading">Loading muscle data...</div>
            </div>
        </div>

        <div class="quick-log">
            <div class="section-title">‚ö° Quick Log</div>
            <div class="quick-log-buttons">
                <button class="log-btn" data-type="Push">Push</button>
                <button class="log-btn" data-type="Pull">Pull</button>
                <button class="log-btn" data-type="Legs">Legs</button>
                <button class="log-btn" data-type="Upper">Upper</button>
                <button class="log-btn" data-type="Lower">Lower</button>
                <button class="log-btn" data-type="Cardio">Cardio</button>
                <button class="log-btn primary" data-action="custom">+ Log Custom Workout</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize the app
        function initApp() {
            console.log('Dashboard initializing...');

            // Apply theme
            if (window.openai?.theme) {
                document.body.className = window.openai.theme;
            }

            // Listen for theme changes
            window.addEventListener('openai:set_globals', (event) => {
                if (event.detail?.globals?.theme) {
                    document.body.className = event.detail.globals.theme;
                }
            });

            // Get data from window.openai
            const toolInput = window.openai?.toolInput || null;
            const toolOutput = window.openai?.toolOutput || null;
            const metadata = window.openai?.toolResponseMetadata || null;
            const widgetState = window.openai?.widgetState || null;
            const locale = window.openai?.locale || 'en-US';
            const displayMode = window.openai?.displayMode || 'inline';

            console.log('toolInput:', toolInput);
            console.log('toolOutput:', toolOutput);
            console.log('metadata:', metadata);

            // Setup button event listeners
            setupQuickLogButtons();

            // Populate dashboard with data
            if (toolOutput) {
                console.log('Populating dashboard with toolOutput:', toolOutput);
                populateDashboard(toolOutput);
            } else if (toolInput) {
                console.log('Populating dashboard with toolInput:', toolInput);
                populateDashboard(toolInput);
            } else {
                console.log('No data available, showing empty state');
                showEmptyState();
            }
        }

        function setupQuickLogButtons() {
            document.querySelectorAll('.log-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const type = btn.dataset.type;
                    const action = btn.dataset.action;

                    if (action === 'custom') {
                        // Request to open the log workout widget
                        if (window.openai?.sendFollowUpMessage) {
                            await window.openai.sendFollowUpMessage({
                                prompt: "Help me log a custom workout"
                            });
                        }
                    } else if (type) {
                        // Quick log a specific workout type
                        if (window.openai?.sendFollowUpMessage) {
                            await window.openai.sendFollowUpMessage({
                                prompt: `Log a ${type} workout`
                            });
                        }
                    }
                });
            });
        }

        function populateDashboard(data) {
            console.log('Populating dashboard with data:', data);

            // Populate stats from toolOutput
            if (data.TotalWorkouts !== undefined || data.totalWorkouts !== undefined) {
                const total = data.TotalWorkouts || data.totalWorkouts || 0;
                document.getElementById('workouts-month').textContent = total;
            }

            if (data.Summary || data.summary) {
                const summary = data.Summary || data.summary;

                if (summary.TotalVolume !== undefined || summary.totalVolume !== undefined) {
                    const volume = summary.TotalVolume || summary.totalVolume || 0;
                    document.getElementById('total-volume').textContent = formatVolume(volume);
                }

                if (summary.AverageSessionDuration !== undefined || summary.averageSessionDuration !== undefined) {
                    const avgDuration = summary.AverageSessionDuration || summary.averageSessionDuration || 0;
                    document.getElementById('avg-duration').textContent = avgDuration;
                }
            }

            // Populate recent workouts
            if (data.Workouts || data.workouts) {
                const workouts = data.Workouts || data.workouts;
                populateRecentWorkouts(workouts);
            }

            // Populate muscle chart
            if (data.Summary?.MuscleGroupDistribution || data.summary?.muscleGroupDistribution) {
                const distribution = data.Summary?.MuscleGroupDistribution || data.summary?.muscleGroupDistribution;
                populateMuscleChart(distribution);
            }

            // Show PR alert if available
            if (data.LatestPR || data.latestPR) {
                showPRAlert(data.LatestPR || data.latestPR);
            }
        }

        function populateRecentWorkouts(workouts) {
            const container = document.getElementById('recent-workouts-list');

            if (!workouts || workouts.length === 0) {
                container.innerHTML = '<div class="empty-state">No workouts logged yet</div>';
                return;
            }

            // Take the 5 most recent workouts
            const recentWorkouts = workouts.slice(0, 5);

            container.innerHTML = recentWorkouts.map(workout => {
                const date = new Date(workout.Date || workout.date);
                const dateStr = formatWorkoutDate(date);
                const muscleGroups = getMuscleGroupsFromWorkout(workout);

                return `
                        <div class="workout-item" onclick="viewWorkout('${workout.Id || workout.id}')">
                            <div class="workout-info">
                                <span class="workout-type">${workout.Type || workout.type || 'Workout'}</span>
                                <span class="workout-date">${dateStr}${muscleGroups ? ' ‚Ä¢ ' + muscleGroups : ''}</span>
                            </div>
                            <span class="workout-duration">${workout.DurationMinutes || workout.durationMinutes || 0} min</span>
                        </div>
                    `;
            }).join('');
        }

        function populateMuscleChart(distribution) {
            const container = document.getElementById('muscle-chart');

            if (!distribution || Object.keys(distribution).length === 0) {
                container.innerHTML = '<div class="empty-state">No muscle group data yet</div>';
                return;
            }

            // Get max value for scaling
            const maxValue = Math.max(...Object.values(distribution));
            const maxHeight = 100;

            container.innerHTML = Object.entries(distribution).map(([muscle, count]) => {
                const height = (count / maxValue) * maxHeight;
                return `
                        <div class="muscle-bar">
                            <div class="muscle-bar-fill" style="height: ${height}px;"></div>
                            <div class="muscle-bar-label">${muscle}</div>
                        </div>
                    `;
            }).join('');
        }

        function showPRAlert(pr) {
            const container = document.getElementById('pr-alert-container');
            container.innerHTML = `
                    <div class="pr-alert">
                        <span class="pr-alert-icon">üèÜ</span>
                        <span class="pr-alert-text">New PR! <span class="pr-exercise">${pr.ExerciseName || pr.exerciseName}</span> - ${pr.MaxWeight || pr.maxWeight} lbs √ó ${pr.Reps || pr.reps} reps</span>
                    </div>
                `;
        }

        function showEmptyState() {
            document.getElementById('recent-workouts-list').innerHTML = `
                    <div class="empty-state">
                        <p>No workouts logged yet</p>
                        <p style="font-size: 12px;">Click "Log Custom Workout" below to get started!</p>
                    </div>
                `;

            document.getElementById('muscle-chart').innerHTML = `
                    <div class="empty-state">No muscle group data yet</div>
                `;
        }

        function formatVolume(volume) {
            if (volume >= 1000) {
                return (volume / 1000).toFixed(1) + 'K';
            }
            return Math.round(volume).toString();
        }

        function formatWorkoutDate(date) {
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;

            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function getMuscleGroupsFromWorkout(workout) {
            const exercises = workout.Exercises || workout.exercises || [];
            if (exercises.length === 0) return '';

            const muscleGroups = [...new Set(exercises.map(ex => ex.MuscleGroup || ex.muscleGroup))];
            return muscleGroups.slice(0, 3).join(', ');
        }

        async function viewWorkout(workoutId) {
            console.log('Viewing workout:', workoutId);
            if (window.openai?.sendFollowUpMessage) {
                await window.openai.sendFollowUpMessage({
                    prompt: `Show me details for workout ${workoutId}`
                });
            }
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        // Re-render on global changes
        window.addEventListener('openai:set_globals', () => {
            console.log('Globals updated, re-rendering dashboard...');
            initApp();
        });
    </script>
</body>
</html>
