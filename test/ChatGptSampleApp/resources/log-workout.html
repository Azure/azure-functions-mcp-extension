<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Workout</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }

        .form-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 24px;
        }

            .header h1 {
                font-size: 24px;
                background: linear-gradient(90deg, #00d9ff, #00ff88);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                margin-bottom: 8px;
            }

            .header p {
                color: #888;
                font-size: 14px;
            }

        .success-banner {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(0, 217, 255, 0.2));
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 20px;
            display: none;
        }

            .success-banner.show {
                display: block;
            }

            .success-banner h2 {
                color: #00ff88;
                font-size: 18px;
                margin-bottom: 8px;
            }

        .success-stats {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }

        .success-stat {
            display: flex;
            flex-direction: column;
        }

        .success-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #00d9ff;
        }

        .success-stat-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
        }

        .form-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #00d9ff;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

            .form-group.full-width {
                grid-column: span 2;
            }

        label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select, textarea {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px;
            color: #fff;
            font-size: 14px;
        }

            input:focus, select:focus, textarea:focus {
                outline: none;
                border-color: #00d9ff;
                background: rgba(0, 217, 255, 0.1);
            }

            input.pre-filled {
                border-color: rgba(0, 255, 136, 0.4);
                background: rgba(0, 255, 136, 0.1);
            }

        select {
            cursor: pointer;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .exercises-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .exercise-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 16px;
        }

            .exercise-card.pre-filled {
                border-color: rgba(0, 255, 136, 0.3);
                background: rgba(0, 255, 136, 0.05);
            }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .exercise-name-input {
            flex: 1;
            font-size: 16px;
            font-weight: 600;
            background: transparent;
            border: none;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0;
            padding: 4px 0;
        }

            .exercise-name-input.pre-filled {
                border-bottom-color: rgba(0, 255, 136, 0.4);
                color: #00ff88;
            }

        .remove-exercise {
            background: rgba(255, 100, 100, 0.2);
            border: none;
            color: #ff6b6b;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .sets-table {
            width: 100%;
            margin-top: 12px;
        }

            .sets-table th {
                font-size: 11px;
                color: #666;
                text-transform: uppercase;
                padding: 8px 4px;
                text-align: center;
            }

            .sets-table td {
                padding: 4px;
            }

            .sets-table input {
                width: 100%;
                text-align: center;
                padding: 8px;
                font-size: 14px;
            }

        .set-number {
            color: #00d9ff;
            font-weight: 600;
            text-align: center;
        }

        .add-set-btn {
            width: 100%;
            margin-top: 8px;
            background: rgba(0, 217, 255, 0.1);
            border: 1px dashed rgba(0, 217, 255, 0.3);
            color: #00d9ff;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .add-exercise-btn {
            width: 100%;
            background: rgba(0, 255, 136, 0.1);
            border: 1px dashed rgba(0, 255, 136, 0.3);
            color: #00ff88;
            padding: 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .feeling-slider {
            display: flex;
            align-items: center;
            gap: 12px;
        }

            .feeling-slider input[type="range"] {
                flex: 1;
                -webkit-appearance: none;
                height: 8px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 4px;
                border: none;
                padding: 0;
            }

                .feeling-slider input[type="range"]::-webkit-slider-thumb {
                    -webkit-appearance: none;
                    width: 20px;
                    height: 20px;
                    background: linear-gradient(135deg, #00d9ff, #00ff88);
                    border-radius: 50%;
                    cursor: pointer;
                }

        .feeling-value {
            min-width: 30px;
            text-align: center;
            font-weight: 600;
            color: #00d9ff;
        }

        .submit-section {
            display: flex;
            gap: 12px;
        }

        .submit-btn {
            flex: 1;
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            border: none;
            color: #1a1a2e;
            padding: 16px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .cancel-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #888;
            padding: 16px 24px;
            border-radius: 8px;
            cursor: pointer;
        }

        .pr-badge {
            background: linear-gradient(135deg, #ffd700, #ff6b35);
            color: #1a1a2e;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <div class="header">
            <h1>üìù Log Workout</h1>
            <p id="header-subtitle">Review and confirm your workout details</p>
        </div>
        <div class="success-banner" id="success-banner">
            <h2>‚úÖ Workout Logged!</h2>
            <div class="success-stats">
                <div class="success-stat"><span class="success-stat-value" id="stat-exercises">0</span><span class="success-stat-label">Exercises</span></div>
                <div class="success-stat"><span class="success-stat-value" id="stat-sets">0</span><span class="success-stat-label">Total Sets</span></div>
                <div class="success-stat"><span class="success-stat-value" id="stat-volume">0</span><span class="success-stat-label">Volume (lbs)</span></div>
                <div class="success-stat"><span class="success-stat-value" id="stat-duration">0</span><span class="success-stat-label">Minutes</span></div>
            </div>
        </div>
        <form id="workout-form">
            <div class="form-section">
                <div class="section-title">Workout Details</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Workout Type</label>
                        <select id="workout-type" required>
                            <option value="Push">Push</option>
                            <option value="Pull">Pull</option>
                            <option value="Legs">Legs</option>
                            <option value="Upper">Upper Body</option>
                            <option value="Lower">Lower Body</option>
                            <option value="FullBody">Full Body</option>
                            <option value="Cardio">Cardio</option>
                            <option value="General">General</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Duration (minutes)</label>
                        <input type="number" id="duration" value="60" min="1" max="300" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Date</label><input type="date" id="workout-date" required></div>
                    <div class="form-group"><label>Time</label><input type="time" id="workout-time"></div>
                </div>
            </div>
            <div class="form-section">
                <div class="section-title">Exercises</div>
                <div class="exercises-list" id="exercises-list"></div>
                <button type="button" class="add-exercise-btn" id="add-exercise">+ Add Exercise</button>
            </div>
            <div class="form-section">
                <div class="section-title">How Did It Feel?</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Perceived Effort (RPE)</label>
                        <div class="feeling-slider">
                            <input type="range" id="effort" min="1" max="10" value="7">
                            <span class="feeling-value" id="effort-value">7</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Energy Level</label>
                        <div class="feeling-slider">
                            <input type="range" id="energy" min="1" max="10" value="7">
                            <span class="feeling-value" id="energy-value">7</span>
                        </div>
                    </div>
                </div>
                <div class="form-group full-width">
                    <label>Notes (optional)</label>
                    <textarea id="notes" placeholder="How did the workout go?"></textarea>
                </div>
            </div>
            <div class="submit-section" id="submit-section">
                <button type="button" class="cancel-btn" id="cancel-btn">Cancel</button>
                <button type="submit" class="submit-btn">üíæ Save Workout</button>
            </div>
        </form>
    </div>
    <script>
        console.log("toolInput:", window.openai?.toolInput)

        let exerciseCount = 0;
        document.getElementById('workout-date').valueAsDate = new Date();
        document.getElementById('effort').addEventListener('input', e => document.getElementById('effort-value').textContent = e.target.value);
        document.getElementById('energy').addEventListener('input', e => document.getElementById('energy-value').textContent = e.target.value);

        // =============================================
        // KEY: Read from window.openai.toolOutput
        // ChatGPT injects structured content here!
        // =============================================
        function initializeFromHostState() {
            const input = window.openai?.toolInput;     // <-- BEFORE tool runs
            const output = window.openai?.toolOutput;   // <-- AFTER tool runs

            console.log("toolInput:", input);
            console.log("toolOutput:", output);

            // If tool already ran and succeeded, show success + populate from output
            if (output && (output.Success || output.success)) {
                showSuccess(output);
                populateWorkout(output.Workout || output.workout || output);
                return;
            }

            // Otherwise, populate from whatever we have (prefer toolInput pre-run)
            const data =
                (output && (output.Workout || output.workout || output)) ||
                (input && (input.Workout || input.workout || input));

            if (data) {
                populateWorkout(data);
            } else {
                addExercise();
            }
        }


        function populateWorkout(data) {
            if (!data) { addExercise(); return; }

            const type = data.Type || data.type;
            if (type) { document.getElementById('workout-type').value = type; document.getElementById('workout-type').classList.add('pre-filled'); }

            const duration = data.DurationMinutes || data.durationMinutes;
            if (duration) { document.getElementById('duration').value = duration; document.getElementById('duration').classList.add('pre-filled'); }

            const date = data.Date || data.date;
            if (date) document.getElementById('workout-date').valueAsDate = new Date(date);

            const effort = data.PerceivedEffort || data.perceivedEffort;
            if (effort) { document.getElementById('effort').value = effort; document.getElementById('effort-value').textContent = effort; }

            const energy = data.EnergyLevel || data.energyLevel;
            if (energy) { document.getElementById('energy').value = energy; document.getElementById('energy-value').textContent = energy; }

            const notes = data.Notes || data.notes;
            if (notes) document.getElementById('notes').value = notes;

            document.getElementById('exercises-list').innerHTML = '';
            exerciseCount = 0;
            const exercises = data.Exercises || data.exercises || [];
            if (exercises.length > 0) {
                exercises.forEach(ex => addExercise(ex.Name || ex.name, ex.MuscleGroup || ex.muscleGroup || 'Chest', ex.Sets || ex.sets || [], true));
            } else {
                addExercise();
            }
        }

        function showSuccess(output) {
            document.getElementById('success-banner').classList.add('show');
            document.getElementById('header-subtitle').textContent = 'Your workout has been saved!';
            const summary = output.Summary || output.summary;
            if (summary) {
                document.getElementById('stat-exercises').textContent = summary.ExerciseCount || summary.exerciseCount || 0;
                document.getElementById('stat-sets').textContent = summary.TotalSets || summary.totalSets || 0;
                document.getElementById('stat-volume').textContent = formatNumber(summary.TotalVolume || summary.totalVolume || 0);
                document.getElementById('stat-duration').textContent = summary.DurationMinutes || summary.durationMinutes || 0;
            }
            document.getElementById('submit-section').style.display = 'none';
        }

        function formatNumber(n) { return n >= 1000 ? (n / 1000).toFixed(1) + 'K' : Math.round(n).toString(); }

        function addExercise(name = '', muscleGroup = 'Chest', sets = [], preFilled = false) {
            exerciseCount++;
            const id = `exercise-${exerciseCount}`;
            let setsHtml = sets.length > 0 ? sets.map((s, i) => `
                <tr>
                    <td class="set-number">${i + 1}${(s.IsPR || s.isPR) ? '<span class="pr-badge">PR!</span>' : ''}</td>
                    <td><input type="number" placeholder="lbs" value="${s.Weight || s.weight || ''}" class="${(s.Weight || s.weight) ? 'pre-filled' : ''}"></td>
                    <td><input type="number" placeholder="reps" value="${s.Reps || s.reps || ''}" class="${(s.Reps || s.reps) ? 'pre-filled' : ''}"></td>
                    <td><input type="number" placeholder="1-10" value="${s.Rpe || s.rpe || ''}"></td>
                </tr>`).join('') : '<tr><td class="set-number">1</td><td><input type="number" placeholder="lbs"></td><td><input type="number" placeholder="reps"></td><td><input type="number" placeholder="1-10"></td></tr>';

            document.getElementById('exercises-list').insertAdjacentHTML('beforeend', `
                <div class="exercise-card ${preFilled ? 'pre-filled' : ''}" id="${id}">
                    <div class="exercise-header">
                        <input type="text" class="exercise-name-input ${preFilled && name ? 'pre-filled' : ''}" placeholder="Exercise name..." value="${name}" required>
                        <select class="muscle-group-dropdown" style="margin:0 12px;padding:6px;">
                            ${['Chest', 'Back', 'Shoulders', 'Biceps', 'Triceps', 'Legs', 'Core', 'Cardio'].map(m => `<option value="${m}" ${muscleGroup === m ? 'selected' : ''}>${m}</option>`).join('')}
                        </select>
                        <button type="button" class="remove-exercise" onclick="removeExercise('${id}')">Remove</button>
                    </div>
                    <table class="sets-table">
                        <thead><tr><th style="width:50px">Set</th><th>Weight</th><th>Reps</th><th style="width:60px">RPE</th></tr></thead>
                        <tbody class="sets-body">${setsHtml}</tbody>
                    </table>
                    <button type="button" class="add-set-btn" onclick="addSet('${id}')">+ Add Set</button>
                </div>`);
        }

        function removeExercise(id) { document.getElementById(id).remove(); }
        function addSet(id) {
            const tbody = document.querySelector(`#${id} .sets-body`);
            tbody.insertAdjacentHTML('beforeend', `<tr><td class="set-number">${tbody.children.length + 1}</td><td><input type="number" placeholder="lbs"></td><td><input type="number" placeholder="reps"></td><td><input type="number" placeholder="1-10"></td></tr>`);
        }

        document.getElementById('add-exercise').addEventListener('click', () => addExercise());

        document.getElementById('workout-form').addEventListener('submit', async e => {
            e.preventDefault();
            const exercises = [...document.querySelectorAll('.exercise-card')].map(card => {
                const sets = [...card.querySelectorAll('.sets-body tr')].map(row => {
                    const inputs = row.querySelectorAll('input');
                    return { Reps: +inputs[1].value || 0, Weight: +inputs[0].value || 0, Rpe: +inputs[2].value || null, IsPR: false };
                }).filter(s => s.Reps > 0);
                return { Name: card.querySelector('.exercise-name-input').value, MuscleGroup: card.querySelector('.muscle-group-dropdown').value, Sets: sets };
            }).filter(e => e.Name && e.Sets.length);

            const data = {
                Type: document.getElementById('workout-type').value,
                DurationMinutes: +document.getElementById('duration').value,
                Date: document.getElementById('workout-date').value,
                Exercises: exercises,
                PerceivedEffort: +document.getElementById('effort').value,
                EnergyLevel: +document.getElementById('energy').value,
                Notes: document.getElementById('notes').value
            };

            if (window.openai?.callTool) {
                await window.openai.callTool('LogWorkout', data);
            }
        });

        document.getElementById('cancel-btn').addEventListener('click', () => window.openai?.requestClose?.());

        const SET_GLOBALS_EVENT_TYPE = "openai:set_globals";

        function boot() {
            // Run once for initial load
            initializeFromHostState();

            // Run again whenever ChatGPT updates globals (including toolOutput)
            window.addEventListener(SET_GLOBALS_EVENT_TYPE, (event) => {
                // If you want, you can gate this on toolOutput being present:
                // if (event?.detail?.globals?.toolOutput === undefined) return;
                initializeFromHostState();

                // Optional: helps if content height changes after rendering
                window.openai?.notifyIntrinsicHeight?.();
            });

            window.addEventListener("openai:set_globals", () => {
                initializeFromHostState();
                window.openai?.notifyIntrinsicHeight?.(); // optional
            });
        }

        if (document.readyState === "loading") {
            document.addEventListener('DOMContentLoaded', initializeFromHostState);
        } else {
            boot();
        }

    </script>
</body>
</html>
