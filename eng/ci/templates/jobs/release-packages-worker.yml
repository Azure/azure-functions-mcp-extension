parameters:
- name: publishToNugetOrg
  type: boolean
- name: artifactName
  type: string
  default: drop
- name: targetFolder
  type: string
  default: ''

resources:
  repositories:
  - repository: 1es
    type: git
    name: 1ESPipelineTemplates/1ESPipelineTemplates
    ref: refs/tags/release
  - repository: eng
    type: git
    name: engineering
    ref: refs/tags/release

extends:
  template: v1/1ES.Official.PipelineTemplate.yml@1es
  parameters:
    pool:
      name: 1es-pool-azfunc
      image: 1es-windows-2022
      os: windows

    stages:

    - stage: Prepare
      jobs:
        - job: Prepare
          templateContext:
            type: validationJob
            inputs:
            - input: pipelineArtifact
              pipeline: build
              artifactName: ${{ parameters.artifactName }}
              targetPath: $(Pipeline.Workspace)/drop

          steps:
          # Parse the version from the nupkg being released, as Directory.Version.props
          # can be influenced by other targets and may not reflect the actual package version.
          - pwsh: |
              $ErrorActionPreference = 'Stop'

              $name = "Microsoft.Azure.Functions.Worker.Extensions.Mcp"
              Write-Host "Getting version for $name"
              # Match the package but exclude the SDK package
              $package = Get-ChildItem -Path "$(Pipeline.Workspace)/drop" -Recurse -Filter "$name.?.*.nupkg" | Where-Object { $_.Name -notlike "*Sdk*" }

              if ($package.Count -eq 0) {
                Write-Host "##vso[task.LogIssue type=error;]Could not find package $name."
                exit 1
              }

              if ($package.Count -gt 1) {
                Write-Host "##vso[task.LogIssue type=error;]Too many packages matched $name."
                exit 1
              }

              $version = $package.Name.Replace("$name.", '').Replace('.nupkg', '')
              Write-Host "Worker Extension Version: $version"
              Write-Host "##vso[build.updatebuildnumber]$version"
              Write-Host "##vso[build.addbuildtag]worker-extension"
              Write-Host "##vso[build.addbuildtag]$version"
            displayName: Get Worker package version

    - stage: Release
      dependsOn: Prepare

      jobs:
      - template: /ci/release-nuget-package.yml@eng
        parameters:
          isProduction: true
          approvers: '[internal]\Azure Functions Core'
          stagingFeed: public/pre-release
          packages: '**/Microsoft.Azure.Functions.Worker.Extensions.Mcp.*.nupkg;!**/Microsoft.Azure.Functions.Worker.Extensions.Mcp.Sdk.*.nupkg'
          artifact:
            name: ${{ parameters.artifactName }}
            pipeline: build
          ${{ if eq(parameters.publishToNugetOrg, true) }}:
            partnerDrop:
              serviceConnection: azure-sdk-partner-drops
              targetFolder: azure-functions/dotnet/mcp-extension/worker/$(Build.BuildNumber)
